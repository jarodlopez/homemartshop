---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.jsx';
import CartDrawer from '../components/CartDrawer.jsx';
import ProductApp from '../components/ProductApp.jsx';
import { db } from '../lib/firebase';
import { collection, getDocs } from 'firebase/firestore';

// 1. Fetch de datos en el servidor (SSR)
// Ahora apuntando a la ruta "cerebro" del POS para mantener sincronía
let products = [];
let categories = [];

try {
  // Ruta exacta donde el POS guarda los productos
  const productsRef = collection(db, "artifacts", "pos-pro-mobile-v2", "public", "data", "products");
  const querySnapshot = await getDocs(productsRef);
  
  products = querySnapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));
  
  // Extraer categorías únicas
  categories = [...new Set(products.map(p => p.category).filter(Boolean))];
} catch (error) {
  console.error("Error fetching products from POS path:", error);
  // Fallback data por si falla la conexión inicial
  products = [];
}
---

<Layout title="HomeMart">
  <!-- Navbar es una isla 'client:load' para manejar el estado del carrito inmediatamente -->
  <Navbar client:load categories={categories} />
  
  <!-- Drawer del carrito con lógica de escritura en POS -->
  <CartDrawer client:load />

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Hero Section -->
    <div class="relative rounded-3xl overflow-hidden bg-gray-900 text-white mb-16 py-20 px-8 text-center">
      <div class="relative z-10">
        <h1 class="text-4xl md:text-6xl font-extrabold mb-6">Construye tu Futuro</h1>
        <p class="text-xl text-gray-300 max-w-2xl mx-auto mb-8">Catálogo profesional sincronizado en tiempo real con nuestro inventario.</p>
      </div>
    </div>

    <!-- La App Principal de Productos -->
    <ProductApp client:visible initialProducts={products} initialCategories={categories} />
  </main>
  
  <footer class="bg-gray-900 text-white py-12 mt-20 text-center">
    <p>© 2026 HomeMart Nicaragua.</p>
  </footer>
</Layout>
